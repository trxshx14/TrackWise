{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
:root {
    --primary-blue: #4a6fa5;
    --primary-dark: #2c5282;
    --primary-darker: #1a365d;
    --accent-light: #a7c5eb;
    --bg-light: #dbe4f0;
    --bg-page: #f0f4f8;
    --success: #4CAF50;
    --success-dark: #45a049;
    --danger: #f44336;
    --danger-dark: #da3226;
    --text-white: #ffffff;
    --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.2);
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.password-body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent-light) 100%);
    min-height: 100vh;
    padding: 100px 20px 50px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.password-container {
    max-width: 500px;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

.password-header {
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
    color: white;
    padding: 2rem;
    text-align: center;
}

.password-header h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.password-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.password-content {
    padding: 2rem;
}

.password-section {
    margin-bottom: 2rem;
}

.section-heading {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    color: var(--primary-dark);
    font-size: 1.1rem;
    font-weight: 600;
}

.section-heading i {
    color: var(--primary-blue);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 600;
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: #fff;
    color: #333;
    font-size: 15px;
    transition: var(--transition);
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-light);
    box-shadow: 0 0 0 3px rgba(167, 197, 235, 0.3);
}

.form-control.error {
    border-color: var(--danger);
    animation: shake 0.3s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.password-strength {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 5px;
    font-size: 0.875rem;
    display: none;
}

.password-weak {
    background-color: #ffe6e6;
    color: #d63031;
}

.password-medium {
    background-color: #fff9e6;
    color: #f39c12;
}

.password-strong {
    background-color: #e6f7e6;
    color: #27ae60;
}

.button-group {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    margin-top: 2rem;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    transition: var(--transition);
    font-size: 14px;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    color: var(--text-white);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.alert {
    padding: 1rem 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border: 1px solid transparent;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.error-message {
    color: var(--danger);
    font-size: 13px;
    margin-top: 5px;
    display: block;
}

.errorlist {
    list-style: none;
    padding: 0;
    margin: 5px 0 0 0;
    color: var(--danger);
    font-size: 13px;
}

.errorlist li {
    margin-bottom: 3px;
}

.field-errors {
    color: var(--danger);
    font-size: 13px;
    margin-top: 5px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
    .password-body {
        padding: 80px 15px 30px;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    .password-header h1 {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block title %}Change Password - TrackWise{% endblock %}

{% block content %}
<div class="password-body">
    <div class="password-container">
        <div class="password-header">
            <h1><i class="fas fa-lock"></i> Change Password</h1>
            <p>Update your account password</p>
        </div>

        <div class="password-content">
            {% comment %} {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %} {% endcomment %}

            {% if form.errors %}
                <div class="alert alert-error">
                    <strong>Please correct the errors below:</strong>
                </div>
            {% endif %}

            <form method="post" id="password-form">
                {% csrf_token %}
                
                <div class="password-section">
                    <h3 class="section-heading">
                        <i class="fas fa-key"></i>
                        Password Information
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.old_password.id_for_label }}">Current Password *</label>
                        <input type="password" 
                               name="old_password" 
                               id="{{ form.old_password.id_for_label }}" 
                               class="form-control {% if form.old_password.errors %}error{% endif %}"
                               value="{{ form.old_password.value|default:'' }}"
                               required>
                        {% if form.old_password.errors %}
                            <ul class="errorlist">
                                {% for error in form.old_password.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.new_password1.id_for_label }}">New Password *</label>
                        <input type="password" 
                               name="new_password1" 
                               id="{{ form.new_password1.id_for_label }}" 
                               class="form-control {% if form.new_password1.errors %}error{% endif %}"
                               value="{{ form.new_password1.value|default:'' }}"
                               required>
                        <div class="password-strength" id="password-strength"></div>
                        {% if form.new_password1.errors %}
                            <ul class="errorlist">
                                {% for error in form.new_password1.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <div class="error-message" id="same-password-error" style="display: none;">
                            New password cannot be the same as current password.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.new_password2.id_for_label }}">Confirm New Password *</label>
                        <input type="password" 
                               name="new_password2" 
                               id="{{ form.new_password2.id_for_label }}" 
                               class="form-control {% if form.new_password2.errors %}error{% endif %}"
                               value="{{ form.new_password2.value|default:'' }}"
                               required>
                        {% if form.new_password2.errors %}
                            <ul class="errorlist">
                                {% for error in form.new_password2.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>

                <div class="button-group">
                    <a href="{% url 'accounts:edit_profile' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Profile
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const oldPasswordInput = document.getElementById('{{ form.old_password.id_for_label }}');
    const newPasswordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const confirmPasswordInput = document.getElementById('{{ form.new_password2.id_for_label }}');
    const passwordStrength = document.getElementById('password-strength');
    const samePasswordError = document.getElementById('same-password-error');
    
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[A-Z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[!@#$%^&*(),.?":{}|<>]+/)) strength++;
        
        switch(strength) {
            case 0:
            case 1:
            case 2:
                feedback = 'Weak password';
                passwordStrength.className = 'password-strength password-weak';
                break;
            case 3:
            case 4:
                feedback = 'Medium strength password';
                passwordStrength.className = 'password-strength password-medium';
                break;
            case 5:
                feedback = 'Strong password';
                passwordStrength.className = 'password-strength password-strong';
                break;
        }
        
        return { strength, feedback };
    }
    
    function checkSamePassword() {
        const oldPassword = oldPasswordInput.value;
        const newPassword = newPasswordInput.value;
        
        if (oldPassword && newPassword && oldPassword === newPassword) {
            samePasswordError.style.display = 'block';
            newPasswordInput.classList.add('error');
            return true;
        } else {
            samePasswordError.style.display = 'none';
            newPasswordInput.classList.remove('error');
            return false;
        }
    }
    
    // Password strength indicator
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            if (password.length > 0) {
                const result = checkPasswordStrength(password);
                passwordStrength.textContent = result.feedback;
                passwordStrength.style.display = 'block';
            } else {
                passwordStrength.style.display = 'none';
            }
            
            // Check if new password is same as current
            checkSamePassword();
        });
    }
    
    // Check for same password when current password changes
    if (oldPasswordInput) {
        oldPasswordInput.addEventListener('input', function() {
            checkSamePassword();
        });
    }
    
    // Form validation
    const passwordForm = document.getElementById('password-form');
    
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            let isValid = true;
            
            // Check if passwords match
            if (newPasswordInput && confirmPasswordInput) {
                if (newPasswordInput.value !== confirmPasswordInput.value) {
                    document.getElementById('{{ form.new_password2.id_for_label }}_error').textContent = 'Passwords do not match';
                    document.getElementById('{{ form.new_password2.id_for_label }}_error').classList.add('show');
                    isValid = false;
                }
            }
            
            // Check if new password is same as current password
            if (checkSamePassword()) {
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                // Scroll to first error
                const firstError = document.querySelector('.errorlist li, .error-message[style*="display: block"]');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    }
    
    // Clear error styling on input
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', function() {
            // Remove error class when user starts typing
            this.classList.remove('error');
            
            // Hide any existing error lists for this field
            const errorList = this.parentNode.querySelector('.errorlist');
            if (errorList) {
                errorList.style.display = 'none';
            }
        });
    });
    
    // Show all error lists on page load
    document.querySelectorAll('.errorlist').forEach(errorList => {
        errorList.style.display = 'block';
    });
});
</script>
{% endblock %}