{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/accounts/base.css' %}">
<link rel="stylesheet" href="{% static 'css/accounts/registration.css' %}">
{% endblock %}

{% block title %}Business Owner Registration - TrackWise{% endblock %}

{% block content %}
<div class="auth-body">
    <div class="auth-container">
        <div class="logo-container">
            <div class="logo-text">
                <i class="fas fa-chart-line"></i>
                TrackWise
            </div>
        </div>
        
        <div class="form-section">
            <div class="auth-header">
                <h2>Create Account</h2>
                <p>Already have an account? <a href="{% url 'accounts:login' %}">Login</a></p>
            </div>

            {% comment %} {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %} {% endcomment %}

            <div class="progress-indicator">
                <div class="progress-step active" id="step1-indicator">1</div>
                <div class="progress-line" id="line1"></div>
                <div class="progress-step" id="step2-indicator">2</div>
            </div>
            
            <form method="post" id="registration-form" novalidate>
                {% csrf_token %}
                
                <div id="personal-info-step">
                    <h3 class="section-heading">
                        <i class="fas fa-user"></i>
                        Personal Information
                    </h3>

                    <!-- Django Form Errors for Step 1 Fields -->
                    {% if form.errors %}
                    <div class="form-errors" style="display: none;">
                        {% for field in form %}
                            {% if field.errors and field.name in 'first_name,last_name,email,username,password1,password2' %}
                                {% for error in field.errors %}
                                    <div data-field="{{ field.name }}">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="{{ form.first_name.id_for_label }}">First Name *</label>
                            {{ form.first_name }}
                            <span class="error-message" id="{{ form.first_name.id_for_label }}_error"></span>
                            {% if form.first_name.errors %}
                                {% for error in form.first_name.errors %}
                                    <span class="error-message show" id="server_{{ form.first_name.id_for_label }}_error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="{{ form.last_name.id_for_label }}">Last Name *</label>
                            {{ form.last_name }}
                            <span class="error-message" id="{{ form.last_name.id_for_label }}_error"></span>
                            {% if form.last_name.errors %}
                                {% for error in form.last_name.errors %}
                                    <span class="error-message show" id="server_{{ form.last_name.id_for_label }}_error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="{{ form.email.id_for_label }}">Email Address *</label>
                        {{ form.email }}
                        <span class="error-message" id="{{ form.email.id_for_label }}_error"></span>
                        {% if form.email.errors %}
                            {% for error in form.email.errors %}
                                <span class="error-message show" id="server_{{ form.email.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="{{ form.username.id_for_label }}">Username *</label>
                        {{ form.username }}
                        <span class="error-message" id="{{ form.username.id_for_label }}_error"></span>
                        {% if form.username.errors %}
                            {% for error in form.username.errors %}
                                <span class="error-message show" id="server_{{ form.username.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ form.password1.id_for_label }}">Password *</label>
                        {{ form.password1 }}
                        <span class="error-message" id="{{ form.password1.id_for_label }}_error"></span>
                        {% if form.password1.errors %}
                            {% for error in form.password1.errors %}
                                <span class="error-message show" id="server_{{ form.password1.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="{{ form.password2.id_for_label }}">Confirm Password *</label>
                        {{ form.password2 }}
                        <span class="error-message" id="{{ form.password2.id_for_label }}_error"></span>
                        {% if form.password2.errors %}
                            {% for error in form.password2.errors %}
                                <span class="error-message show" id="server_{{ form.password2.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-primary" id="continue-btn">
                            <span>Continue</span>
                        </button>
                    </div>
                </div>
                
                <div id="company-info-step" style="display: none;">
                    <h3 class="section-heading">
                        <i class="fas fa-building"></i>
                        Company Information
                    </h3>
                    
                    <!-- Django Form Errors for Step 2 Fields -->
                    {% if form.errors %}
                    <div class="form-errors" style="display: none;">
                        {% for field in form %}
                            {% if field.errors and field.name in 'new_company_name,existing_company,company_choice' %}
                                {% for error in field.errors %}
                                    <div data-field="{{ field.name }}">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label class="form-label">Company Option *</label>
                        <div class="radio-group">
                            {{ form.company_choice }}
                        </div>
                    </div>
                    
                    <div id="existing-company-fields" class="company-field" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="{{ form.existing_company.id_for_label }}">Select Company</label>
                            {{ form.existing_company }}
                            <span class="error-message" id="{{ form.existing_company.id_for_label }}_error"></span>
                            {% if form.existing_company.errors %}
                                {% for error in form.existing_company.errors %}
                                    <span class="error-message show" id="server_{{ form.existing_company.id_for_label }}_error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div id="new-company-fields" class="company-field">
                        <div class="form-group">
                            <label class="form-label" for="{{ form.new_company_name.id_for_label }}">Company Name *</label>
                            {{ form.new_company_name }}
                            <span class="error-message" id="{{ form.new_company_name.id_for_label }}_error"></span>
                            {% if form.new_company_name.errors %}
                                {% for error in form.new_company_name.errors %}
                                    <span class="error-message show" id="server_{{ form.new_company_name.id_for_label }}_error">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="{{ form.company_address.id_for_label }}">Company Address</label>
                            {{ form.company_address }}
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="{{ form.company_contact.id_for_label }}">Contact Information</label>
                            {{ form.company_contact }}
                        </div>
                    </div>
                    
                    <div class="terms-group">
                        <input type="checkbox" id="terms" name="terms" required>
                        <label for="terms">I agree to all statements in Terms of Service</label>
                    </div>
                    <span class="error-message" id="terms_error">You must agree to the terms</span>

                    <div class="button-group">
                        <button type="button" class="btn btn-danger" id="back-btn">
                            <span>Back</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <span>Register</span>
                        </button>
                    </div>
                </div>
            </form>
            
            <div class="auth-footer">
                <p class="footer-content">
                    <a href="{% url 'accounts:landing' %}" class="footer-home-link">
                        <i class="fas fa-home"></i> Back to Home
                    </a>
                    <a>|</a>
                    <span class="footer-spacer"></span>
                    <a href="#" class="footer-support-link">Contact Support</a>
                </p>
            </div>
        </div>

        <div class="particles-section" id="particles-js"></div>
        <!-- OTP Verification Modal -->
        <div id="otpModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; animation: fadeIn 0.3s ease-out; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div class="modal-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 54, 93, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"></div>
            <div class="modal-container" style="position: relative; display: flex; justify-content: center; align-items: center; min-height: 100%; padding: 20px;">
                <div class="modal-content" style="background: var(--text-white, #ffffff); border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); border: 1px solid var(--bg-light, #dbe4f0); overflow: hidden; animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative;">
                    
                    <div class="modal-header" style="padding: 30px 30px 20px; text-align: center; background: var(--bg-page, #f0f4f8); border-bottom: 1px solid var(--bg-light, #dbe4f0); position: relative;">
                        <div class="modal-icon" style="width: 56px; height: 56px; background: var(--primary-dark, #2c5282); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 4px 15px rgba(44, 82, 130, 0.3);">
                            <i class="fas fa-shield-alt" style="font-size: 24px; color: var(--text-white, #ffffff);"></i>
                        </div>
                        <h3 style="margin: 0 0 8px 0; color: var(--primary-darker, #1a365d); font-size: 1.4em; font-weight: 700;">Two-Factor Verification</h3>
                        <p class="modal-subtitle" style="margin: 0; color: #6c757d; font-size: 0.9em;">A 6-digit code has been sent to your email.</p>
                        <span class="close" style="position: absolute; top: 15px; right: 15px; font-size: 28px; font-weight: 300; color: #a7c5eb; cursor: pointer; transition: color 0.3s ease; line-height: 1; user-select: none;">&times;</span>
                    </div>
                    
                    <div class="modal-body" style="padding: 30px;">
                        <div class="email-info" style="display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--bg-light, #dbe4f0); padding: 12px; border-radius: 8px; margin-bottom: 25px; border: 1px solid var(--accent-light, #a7c5eb);">
                            <i class="fas fa-envelope-open-text" style="color: var(--primary-dark, #2c5282); font-size: 1em;"></i>
                            <span id="verify-email-display" class="email-address" style="font-weight: 500; color: var(--primary-darker, #1a365d); font-size: 0.9em;"></span>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label class="form-label" style="display: block; margin-bottom: 8px; color: var(--primary-darker, #1a365d); font-weight: 600; font-size: 0.9em;">Verification Code</label>
                            <input type="text" id="otp-input" class="form-control otp-input" maxlength="6" placeholder=" _    _    _    _    _    _ " 
                                pattern="[0-9]{6}" title="Please enter 6 digits" 
                                style="width: 100%; text-align: center; font-size: 1.6em; letter-spacing: 0.7em; font-weight: 700; padding: 15px 20px; border: 2px solid var(--accent-light, #a7c5eb); border-radius: 8px; background: var(--text-white, #ffffff); transition: all 0.3s ease; color: var(--primary-darker, #1a365d); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08); box-sizing: border-box; outline: none;">
                            <span class="error-message" id="otp-error" style="display: none; color: var(--danger, #f44336); font-size: 0.8em; margin-top: 5px;"></span>
                        </div>
                        
                        <div class="resend-section" style="margin-top: 20px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.85em;">Trouble receiving the code?</p>
                            <div class="resend-actions" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <a href="#" id="resend-code" class="resend-link" style="color: var(--primary-dark, #2c5282); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; padding: 10px 20px; border-radius: 8px; transition: all 0.3s ease; background: var(--accent-light, #a7c5eb); border: 1px solid var(--primary-blue, #4a6fa5);">
                                    <i class="fas fa-redo"></i> Resend Code
                                </a>
                                <span id="resend-timer" class="resend-timer" style="color: #6c757d; font-size: 0.8em; display: none; padding: 4px 8px; background: var(--bg-page, #f0f4f8); border-radius: 4px;">
                                    Resend available in <span id="countdown">60</span>s
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="padding: 20px 30px; display: flex; gap: 10px; justify-content: space-between; background: var(--bg-page, #f0f4f8); border-top: 1px solid var(--bg-light, #dbe4f0);">
                        <button type="button" class="btn btn-secondary" id="cancel-verify" style="flex: 1; padding: 10px 15px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s ease; border: 1px solid var(--primary-blue, #4a6fa5); cursor: pointer; background: var(--text-white, #ffffff); color: var(--primary-blue, #4a6fa5); font-size: 0.9em;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary" id="verify-code" style="flex: 1; padding: 10px 15px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s ease; border: none; cursor: pointer; background: var(--primary-dark, #2c5282); color: var(--text-white, #ffffff); box-shadow: 0 4px 10px rgba(44, 82, 130, 0.4); font-size: 0.9em;">
                            <span>Verify</span>
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
    // Particles configuration
    particlesJS('particles-js', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#7aa7e0' },
            shape: { type: 'circle' },
            opacity: { value: 0.8, random: true },
            size: { value: 20, random: true }, // Increased from 8 to 12
            line_linked: {
                enable: true,
                distance: 150,
                color: '#7aa7e0',
                opacity: 0.6,
                width: 2
            },
            move: {
                enable: true,
                speed: 1.5,
                direction: 'none',
                random: true,
                out_mode: 'out'
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'grab' },
                resize: true
            },
            modes: {
                grab: { distance: 180, line_linked: { opacity: 1 } }
            }
        },
        retina_detect: true
    });

    // Form validation and step management
    const form = document.getElementById('registration-form');
    const step1 = document.getElementById('personal-info-step');
    const step2 = document.getElementById('company-info-step');
    const continueBtn = document.getElementById('continue-btn');
    const backBtn = document.getElementById('back-btn');
    const step1Indicator = document.getElementById('step1-indicator');
    const step2Indicator = document.getElementById('step2-indicator');
    const line1 = document.getElementById('line1');

    const otpModal = document.getElementById('otpModal');
    const closeModal = document.querySelector('.close');
    const cancelVerify = document.getElementById('cancel-verify');
    const verifyCodeBtn = document.getElementById('verify-code');
    const resendCodeBtn = document.getElementById('resend-code');
    const resendTimer = document.getElementById('resend-timer');
    const countdownElement = document.getElementById('countdown');
    const otpInput = document.getElementById('otp-input');
    const otpError = document.getElementById('otp-error');

    let resendCooldown = 60;
    let countdownInterval = null;

    // Check if there are server-side errors and show appropriate step
    document.addEventListener('DOMContentLoaded', function() {
        const serverErrors = document.querySelectorAll('.error-message.show');
        const hasStep1Errors = Array.from(serverErrors).some(error => {
            return error.id.includes('first_name') || 
                   error.id.includes('last_name') || 
                   error.id.includes('email') || 
                   error.id.includes('username') || 
                   error.id.includes('password1') || 
                   error.id.includes('password2');
        });
        
        const hasStep2Errors = Array.from(serverErrors).some(error => {
            return error.id.includes('company_name') || 
                   error.id.includes('existing_company') || 
                   error.id.includes('company_choice');
        });

        if (hasStep2Errors || (hasStep1Errors && step2.style.display !== 'none')) {
            // Show step 2 if there are step 2 errors or if we're already on step 2 with errors
            step1.style.display = 'none';
            step2.style.display = 'block';
            step1Indicator.classList.add('completed');
            step1Indicator.innerHTML = '<i class="fas fa-check"></i>';
            step2Indicator.classList.add('active');
            line1.classList.add('completed');
        }
        
        // Initialize company fields based on current selection
        toggleCompanyFields();
    });

    // Validation functions
    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input) {
            input.classList.add('error');
            // Also add to Django's error list if it exists
            const serverError = document.getElementById('server_' + errorId);
            if (serverError) {
                serverError.style.display = 'none';
            }
        }
        if (error) {
            error.textContent = message;
            error.classList.add('show');
        }
    }

    function clearError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input) input.classList.remove('error');
        if (error) error.classList.remove('show');
        
        // Also handle server errors
        const serverError = document.getElementById('server_' + errorId);
        if (serverError) {
            serverError.classList.remove('show');
        }
    }

    async function validateStep1() {
        let isValid = true;

        // Clear all step 1 errors first
        clearError('{{ form.first_name.id_for_label }}', '{{ form.first_name.id_for_label }}_error');
        clearError('{{ form.last_name.id_for_label }}', '{{ form.last_name.id_for_label }}_error');
        clearError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error');
        clearError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error');
        clearError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error');
        clearError('{{ form.password2.id_for_label }}', '{{ form.password2.id_for_label }}_error');

        // First name validation
        const firstName = document.getElementById('{{ form.first_name.id_for_label }}').value.trim();
        if (!firstName) {
            showError('{{ form.first_name.id_for_label }}', '{{ form.first_name.id_for_label }}_error', 'First name is required');
            isValid = false;
        }

        // Last name validation
        const lastName = document.getElementById('{{ form.last_name.id_for_label }}').value.trim();
        if (!lastName) {
            showError('{{ form.last_name.id_for_label }}', '{{ form.last_name.id_for_label }}_error', 'Last name is required');
            isValid = false;
        }

        // Email validation with uniqueness check
        const email = document.getElementById('{{ form.email.id_for_label }}').value.trim();
        if (!email) {
            showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', 'Email is required');
            isValid = false;
        } else if (!validateEmail(email)) {
            showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', 'Valid email is required');
            isValid = false;
        } else {
            // Check email uniqueness
            const isEmailAvailable = await checkEmailUniqueness(email);
            if (!isEmailAvailable) {
                showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', 'This email is already registered');
                isValid = false;
            }
        }

        // Username validation with uniqueness check
        const username = document.getElementById('{{ form.username.id_for_label }}').value.trim();
        if (!username) {
            showError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error', 'Username is required');
            isValid = false;
        } else if (username.length < 3) {
            showError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error', 'Username must be at least 3 characters');
            isValid = false;
        } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            showError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error', 'Username can only contain letters, numbers, and underscores');
            isValid = false;
        } else {
            // Check username uniqueness
            const isUsernameAvailable = await checkUsernameUniqueness(username);
            if (!isUsernameAvailable) {
                showError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error', 'This username is already taken');
                isValid = false;
            }
        }

        // Password validation
        const password = document.getElementById('{{ form.password1.id_for_label }}').value;
        const confirmPassword = document.getElementById('{{ form.password2.id_for_label }}').value;

        // Check if password is provided
        if (!password) {
            showError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error', 'Password is required');
            isValid = false;
        } else {
            // Comprehensive password requirements check
            const passwordErrors = validatePasswordRequirements(password);
            if (passwordErrors.length > 0) {
                showError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error', passwordErrors.join(', '));
                isValid = false;
            }
        }

        // Confirm password validation
        if (!confirmPassword) {
            showError('{{ form.password2.id_for_label }}', '{{ form.password2.id_for_label }}_error', 'Please confirm your password');
            isValid = false;
        } else if (confirmPassword !== password) {
            showError('{{ form.password2.id_for_label }}', '{{ form.password2.id_for_label }}_error', 'Passwords must match');
            isValid = false;
        }

        return isValid;
    }

    function validateStep2() {
        let isValid = true;
        
        // Clear step 2 errors
        clearError('{{ form.new_company_name.id_for_label }}', '{{ form.new_company_name.id_for_label }}_error');
        clearError('{{ form.existing_company.id_for_label }}', '{{ form.existing_company.id_for_label }}_error');
        document.getElementById('terms_error').classList.remove('show');

        const companyChoice = document.querySelector('input[name="company_choice"]:checked').value;

        if (companyChoice === 'new') {
            const companyName = document.getElementById('{{ form.new_company_name.id_for_label }}').value.trim();
            if (!companyName) {
                showError('{{ form.new_company_name.id_for_label }}', '{{ form.new_company_name.id_for_label }}_error', 'Company name is required');
                isValid = false;
            }
        } else {
            const existingCompany = document.getElementById('{{ form.existing_company.id_for_label }}').value;
            if (!existingCompany) {
                showError('{{ form.existing_company.id_for_label }}', '{{ form.existing_company.id_for_label }}_error', 'Please select an existing company');
                isValid = false;
            }
        }

        const terms = document.getElementById('terms').checked;
        if (!terms) {
            document.getElementById('terms_error').classList.add('show');
            isValid = false;
        }

        return isValid;
    }

    // Real-time uniqueness validation
    async function checkEmailUniqueness(email) {
        try {
            const response = await fetch('/api/check-email/', { // You'll need to create this endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ email: email })
            });
            
            const data = await response.json();
            return data.is_available;
        } catch (error) {
            console.error('Error checking email:', error);
            return true; // Assume available on error to not block user
        }
    }

    async function checkUsernameUniqueness(username) {
        try {
            const response = await fetch('/api/check-username/', { // You'll need to create this endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ username: username })
            });
            
            const data = await response.json();
            return data.is_available;
        } catch (error) {
            console.error('Error checking username:', error);
            return true;
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function validatePasswordRequirements(password) {
        const errors = [];
        
        // Check minimum length
        if (password.length < 8) {
            errors.push('Password must be at least 8 characters long');
        }
        
        // Check if entirely numeric
        if (/^\d+$/.test(password)) {
            errors.push('Password cannot be entirely numeric');
        }
        
        // Check for common patterns (optional but recommended)
        if (password.toLowerCase().includes('password') || password.toLowerCase().includes('123')) {
            errors.push('Password is too common or easily guessable');
        }
        
        // Check for mixed case and numbers (optional enhancement)
        if (!/(?=.*[a-z])(?=.*[A-Z])/.test(password)) {
            errors.push('Password should contain both uppercase and lowercase letters');
        }
        
        if (!/(?=.*\d)/.test(password)) {
            errors.push('Password should contain at least one number');
        }
        
        return errors;
    }

    // Real-time password strength indicator
    function updatePasswordStrength(password) {
        const strengthIndicator = document.getElementById('password-strength');
        if (!strengthIndicator) return;
        
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength++;
        if (!/^\d+$/.test(password)) strength++;
        if (/(?=.*[a-z])(?=.*[A-Z])/.test(password)) strength++;
        if (/(?=.*\d)/.test(password)) strength++;
        if (/(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?])/.test(password)) strength++;
        
        switch(strength) {
            case 0:
            case 1:
                feedback = 'Very Weak';
                strengthIndicator.className = 'password-strength very-weak';
                break;
            case 2:
                feedback = 'Weak';
                strengthIndicator.className = 'password-strength weak';
                break;
            case 3:
                feedback = 'Fair';
                strengthIndicator.className = 'password-strength fair';
                break;
            case 4:
                feedback = 'Strong';
                strengthIndicator.className = 'password-strength strong';
                break;
            case 5:
                feedback = 'Very Strong';
                strengthIndicator.className = 'password-strength very-strong';
                break;
        }
        
        strengthIndicator.textContent = `Password Strength: ${feedback}`;
        strengthIndicator.style.display = 'block';
    }

    // Real-time email validation
    document.getElementById('{{ form.email.id_for_label }}').addEventListener('blur', async function() {
        const email = this.value.trim();
        if (email && validateEmail(email)) {
            const isAvailable = await checkEmailUniqueness(email);
            if (!isAvailable) {
                showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', 'This email is already registered');
            } else {
                clearError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error');
            }
        }
    });

    // Real-time username validation
    document.getElementById('{{ form.username.id_for_label }}').addEventListener('blur', async function() {
        const username = this.value.trim();
        if (username && username.length >= 3) {
            const isAvailable = await checkUsernameUniqueness(username);
            if (!isAvailable) {
                showError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error', 'This username is already taken');
            } else {
                clearError('{{ form.username.id_for_label }}', '{{ form.username.id_for_label }}_error');
            }
        }
    });

    // Real-time password validation
    document.getElementById('{{ form.password1.id_for_label }}').addEventListener('input', function() {
        const password = this.value;
        
        // Update password strength indicator
        updatePasswordStrength(password);
        
        // Clear errors when user starts typing
        if (password.length > 0) {
            clearError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error');
            
            // Basic validation in real-time
            if (password.length < 8) {
                showError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error', 'Password must be at least 8 characters');
            } else if (/^\d+$/.test(password)) {
                showError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error', 'Password cannot be entirely numeric');
            } else {
                clearError('{{ form.password1.id_for_label }}', '{{ form.password1.id_for_label }}_error');
            }
        }
    });

    // Real-time password confirmation validation
    document.getElementById('{{ form.password2.id_for_label }}').addEventListener('input', function() {
        const confirmPassword = this.value;
        const password = document.getElementById('{{ form.password1.id_for_label }}').value;
        
        if (confirmPassword && password !== confirmPassword) {
            showError('{{ form.password2.id_for_label }}', '{{ form.password2.id_for_label }}_error', 'Passwords must match');
        } else {
            clearError('{{ form.password2.id_for_label }}', '{{ form.password2.id_for_label }}_error');
        }
    });

    // Continue button - validate step 1 before proceeding
    continueBtn.addEventListener('click', async () => {
        // Show loading state
        continueBtn.disabled = true;
        continueBtn.innerHTML = '<span>Validating...</span>';
        
        if (await validateStep1()) {
            const email = document.getElementById('{{ form.email.id_for_label }}').value.trim();
            await sendVerificationCode(email);
        } else {
            // Scroll to first error
            const firstError = document.querySelector('.error-message.show');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            // Reset button state
            continueBtn.disabled = false;
            continueBtn.innerHTML = '<span>Continue</span>';
        }
    });

    // Send verification code
    async function sendVerificationCode(email) {
        try {
            const response = await fetch("{% url 'accounts:send_verification_code' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ email: email })
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response');
            }
            
            const data = await response.json();
            
            if (data.success) {
                showOtpModal(email);
            } else {
                showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', data.error || 'Failed to send verification code');
            }
        } catch (error) {
            console.error('Error sending verification code:', error);
            showError('{{ form.email.id_for_label }}', '{{ form.email.id_for_label }}_error', 'Network error. Please try again.');
        } finally {
            // Reset button state
            continueBtn.disabled = false;
            continueBtn.innerHTML = '<span>Continue</span>';
        }
    }

    // Show OTP modal
    function showOtpModal(email) {
        document.getElementById('verify-email-display').textContent = email;
        otpModal.style.display = 'block';
        otpInput.value = '';
        otpInput.focus();
        otpError.textContent = '';
        otpError.classList.remove('show');
        
        // Prevent background scrolling
        document.body.style.overflow = 'hidden';
        
        // Start resend cooldown
        startResendCooldown();
    }

    // Hide OTP modal
    function hideOtpModal() {
        otpModal.style.display = 'none';
        // Restore background scrolling
        document.body.style.overflow = '';
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }

    // Start resend cooldown timer
    function startResendCooldown() {
        resendCooldown = 60;
        resendCodeBtn.style.display = 'none';
        resendTimer.style.display = 'block';
        countdownElement.textContent = resendCooldown;
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        countdownInterval = setInterval(() => {
            resendCooldown--;
            countdownElement.textContent = resendCooldown;
            
            if (resendCooldown <= 0) {
                clearInterval(countdownInterval);
                resendCodeBtn.style.display = 'inline';
                resendTimer.style.display = 'none';
            }
        }, 1000);
    }

    // Verify OTP code
    async function verifyOtpCode(email, code) {
        try {
            verifyCodeBtn.disabled = true;
            verifyCodeBtn.classList.add('btn-loading');
            otpInput.disabled = true;
            
            const response = await fetch("{% url 'accounts:verify_email_code' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ 
                    email: email,
                    code: code
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                otpInput.classList.add('success');
                // Add success animation
                setTimeout(() => {
                    hideOtpModal();
                    proceedToStep2();
                }, 800);
            } else {
                otpInput.classList.add('error');
                otpError.textContent = data.error || 'Invalid verification code';
                otpError.classList.add('show');
                
                // Clear input and focus for retry
                setTimeout(() => {
                    otpInput.value = '';
                    otpInput.focus();
                    otpInput.classList.remove('error');
                }, 2000);
            }
        } catch (error) {
            console.error('Error verifying OTP:', error);
            otpError.textContent = 'Network error. Please try again.';
            otpError.classList.add('show');
        } finally {
            verifyCodeBtn.disabled = false;
            verifyCodeBtn.classList.remove('btn-loading');
            otpInput.disabled = false;
        }
    }

    // Proceed to step 2 after successful verification
    function proceedToStep2() {
        step1.style.display = 'none';
        step2.style.display = 'block';
        step1Indicator.classList.add('completed');
        step1Indicator.innerHTML = '<i class="fas fa-check"></i>';
        step2Indicator.classList.add('active');
        line1.classList.add('completed');
        document.querySelector('.form-section').scrollTop = 0;
    }

    // Event listeners for OTP modal
    closeModal.addEventListener('click', hideOtpModal);
    cancelVerify.addEventListener('click', hideOtpModal);

    verifyCodeBtn.addEventListener('click', () => {
        const email = document.getElementById('{{ form.email.id_for_label }}').value.trim();
        const code = otpInput.value.trim();
        
        if (!code || code.length !== 6) {
            otpError.textContent = 'Please enter a valid 6-digit code';
            otpError.classList.add('show');
            return;
        }
        
        verifyOtpCode(email, code);
    });

    resendCodeBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = document.getElementById('{{ form.email.id_for_label }}').value.trim();
        await sendVerificationCode(email);
    });

    // OTP input validation
    otpInput.addEventListener('input', function() {
        // Only allow numbers
        this.value = this.value.replace(/\D/g, '');
        
        // Limit to 6 characters
        if (this.value.length > 6) {
            this.value = this.value.slice(0, 6);
        }
        
        // Visual feedback
        if (this.value.length === 6) {
            this.classList.add('success');
            this.classList.remove('error');
            // Auto-verify when 6 digits are entered
            setTimeout(() => {
                if (this.value.length === 6) {
                    verifyCodeBtn.click();
                }
            }, 300);
        } else {
            this.classList.remove('success', 'error');
        }
        
        // Clear error when user types
        if (this.value.length > 0) {
            otpError.textContent = '';
            otpError.classList.remove('show');
        }
    });

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === otpModal) {
            hideOtpModal();
        }
    });

    // Back button
    backBtn.addEventListener('click', () => {
        step2.style.display = 'none';
        step1.style.display = 'block';
        step1Indicator.classList.remove('completed');
        step1Indicator.textContent = '1';
        step2Indicator.classList.remove('active');
        line1.classList.remove('completed');
        document.querySelector('.form-section').scrollTop = 0;
    });

    // Form submission - validate step 2
    form.addEventListener('submit', (e) => {
        if (!validateStep2()) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.error-message.show');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Company option toggle
    const companyRadios = document.querySelectorAll('input[name="company_choice"]');
    const existingFields = document.getElementById('existing-company-fields');
    const newFields = document.getElementById('new-company-fields');

    function toggleCompanyFields() {
        const selectedValue = document.querySelector('input[name="company_choice"]:checked').value;
        if (selectedValue === 'existing') {
            existingFields.style.display = 'block';
            newFields.style.display = 'none';
            clearError('{{ form.new_company_name.id_for_label }}', '{{ form.new_company_name.id_for_label }}_error');
        } else {
            existingFields.style.display = 'none';
            newFields.style.display = 'block';
            clearError('{{ form.existing_company.id_for_label }}', '{{ form.existing_company.id_for_label }}_error');
        }
    }

    companyRadios.forEach(radio => {
        radio.addEventListener('change', toggleCompanyFields);
    });

    // Clear errors on input
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', () => {
            const errorId = input.id + '_error';
            clearError(input.id, errorId);
        });
    });

    // Clear terms error when checkbox is checked
    document.getElementById('terms').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('terms_error').classList.remove('show');
        }
    });
</script>
{% endblock %}