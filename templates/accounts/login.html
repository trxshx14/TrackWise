{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/accounts/base.css' %}">
<link rel="stylesheet" href="{% static 'css/accounts/login.css' %}">
{% endblock %}

{% block title %}Login - TrackWise{% endblock %}

{% block content %}
<div class="auth-body">
    <div class="auth-container">
        <div class="logo-container">
            <div class="logo-text">
                <i class="fas fa-chart-line"></i>
                TrackWise
            </div>
        </div>
        
        <div class="form-section">
            <div class="auth-header">
                <h2>Welcome Back</h2>
                <p>Don't have an account? <a href="{% url 'accounts:business_owner_register' %}">Sign up</a></p>
            </div>

            {# Only show Django messages (not form errors) here #}
            {% if messages %}
                <div class="messages-container">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            <div class="alert-icon">
                                {% if message.tags == 'error' or message.tags == 'danger' %}
                                    <i class="fas fa-exclamation-circle"></i>
                                {% elif message.tags == 'success' %}
                                    <i class="fas fa-check-circle"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% else %}
                                    <i class="fas fa-info-circle"></i>
                                {% endif %}
                            </div>
                            <div class="alert-content">
                                {{ message }}
                            </div>
                            <button type="button" class="alert-close" onclick="this.parentElement.style.display='none'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            {# Combined form errors container #}
            {% if form.non_field_errors %}
                <div class="alert alert-error">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="alert-content">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    <button type="button" class="alert-close" onclick="this.parentElement.style.display='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endif %}
            
            <form method="post" id="login-form" novalidate>
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label" for="{{ form.username.id_for_label }}">Username *</label>
                    {{ form.username }}
                    <span class="error-message" id="username-error"></span>
                    {% if form.username.errors %}
                        {% for error in form.username.errors %}
                            <span class="error-message server-error">
                                <i class="fas fa-exclamation-circle"></i> {{ error }}
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="{{ form.password.id_for_label }}">Password *</label>
                    {{ form.password }}
                    <span class="error-message" id="password-error"></span>
                    {% if form.password.errors %}
                        {% for error in form.password.errors %}
                            <span class="error-message server-error">
                                <i class="fas fa-exclamation-circle"></i> {{ error }}
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-success">
                        <span>Sign In</span>
                    </button>
                </div>
            </form>
            
            <div class="auth-footer">
                <p class="footer-content">
                    <a href="{% url 'accounts:landing' %}" class="footer-home-link">
                        <i class="fas fa-home"></i> Back to Home
                    </a>
                    <a>|</a>
                    <span class="footer-spacer"></span>
                    <a href="#" class="footer-support-link">Contact Support</a>
                </p>
            </div>
        </div>
        
        <div class="particles-section" id="particles-js"></div>
        
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
    // Particles configuration
    particlesJS('particles-js', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#7aa7e0' },
            shape: { type: 'circle' },
            opacity: { value: 0.8, random: true },
            size: { value: 20, random: true },
            line_linked: {
                enable: true,
                distance: 150,
                color: '#7aa7e0',
                opacity: 0.6,
                width: 2
            },
            move: {
                enable: true,
                speed: 1.5,
                direction: 'none',
                random: true,
                out_mode: 'out'
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'grab' },
                resize: true
            },
            modes: {
                grab: { distance: 180, line_linked: { opacity: 1 } }
            }
        },
        retina_detect: true
    });

    // Form validation
    const form = document.getElementById('login-form');
    const usernameInput = document.getElementById('{{ form.username.id_for_label }}');
    const passwordInput = document.getElementById('{{ form.password.id_for_label }}');
    const usernameError = document.getElementById('username-error');
    const passwordError = document.getElementById('password-error');

    // Clear server errors on input
    function clearServerErrors() {
        document.querySelectorAll('.server-error').forEach(error => {
            error.style.opacity = '0.5';
            setTimeout(() => {
                error.style.display = 'none';
            }, 300);
        });
        
        // Remove any error classes from inputs
        usernameInput.classList.remove('error');
        passwordInput.classList.remove('error');
    }

    // Clear client errors
    function clearClientErrors() {
        usernameError.innerHTML = '';
        usernameError.classList.remove('show');
        passwordError.innerHTML = '';
        passwordError.classList.remove('show');
    }

    // Show error function
    function showError(inputElement, errorElement, message) {
        inputElement.classList.add('error');
        errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
        errorElement.classList.add('show');
        
        // Hide any server errors for this field
        const serverErrors = inputElement.parentNode.querySelectorAll('.server-error');
        serverErrors.forEach(error => {
            error.style.opacity = '0.5';
            setTimeout(() => {
                error.style.display = 'none';
            }, 300);
        });
    }

    function validateForm() {
        let isValid = true;
        
        // Clear previous client errors
        clearClientErrors();
        
        // Username validation
        const username = usernameInput.value.trim();
        if (!username) {
            showError(usernameInput, usernameError, 'Username is required');
            isValid = false;
        }

        // Password validation
        const password = passwordInput.value;
        if (!password) {
            showError(passwordInput, passwordError, 'Password is required');
            isValid = false;
        }

        return isValid;
    }

    // Clear errors on input
    [usernameInput, passwordInput].forEach(input => {
        input.addEventListener('input', () => {
            clearServerErrors();
            clearClientErrors();
            input.classList.remove('error');
        });
    });

    // Form submission
    form.addEventListener('submit', (e) => {
        if (!validateForm()) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.error-message.show');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            // Clear all errors before submitting if form is valid
            clearClientErrors();
            clearServerErrors();
        }
    });

    // On page load, check if there are server errors and style inputs accordingly
    document.addEventListener('DOMContentLoaded', function() {
        // Add error class to inputs that have server errors
        const serverErrors = document.querySelectorAll('.server-error');
        serverErrors.forEach(error => {
            const input = error.previousElementSibling;
            if (input && input.tagName === 'INPUT') {
                input.classList.add('error');
            }
        });
        
        // Auto-hide messages after 8 seconds
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 500);
            });
        }, 8000);
    });
</script>

<style>
/* Enhanced CSS for messages and errors - Using --danger color for all errors */
:root {
    --danger: #f44336;
    --danger-dark: #da3226;
    --success: #4CAF50;
    --warning: #ff9800;
    --info: #2196F3;
}

.messages-container {
    margin-bottom: 25px;
}

.alert {
    display: flex;
    align-items: flex-start;
    padding: 18px 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    border: 2px solid transparent;
    position: relative;
    transition: all 0.3s ease;
    animation: slideIn 0.5s ease-out;
    backdrop-filter: blur(5px);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert-icon {
    font-size: 22px;
    margin-right: 15px;
    flex-shrink: 0;
    margin-top: 2px;
}

.alert-content {
    flex: 1;
    font-weight: 500;
    font-size: 15px;
    line-height: 1.5;
}

.alert-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
    padding: 0;
    margin-left: 10px;
    flex-shrink: 0;
    margin-top: 2px;
}

.alert-close:hover {
    opacity: 1;
}

/* ALL ERROR ALERTS USE --danger COLOR */
.alert-error,
.alert-danger,
.alert-warning,
.alert-success,
.alert-info {
    background: linear-gradient(135deg, var(--danger), var(--danger-dark));
    border-color: #ff6b7d;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Override other alert types to also use danger color */
.alert-error::before,
.alert-danger::before,
.alert-warning::before,
.alert-success::before,
.alert-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 12px 12px 0 0;
}

/* Error message styling under form fields - Using --danger color */
.error-message {
    display: none;
    font-size: 14px;
    padding: 10px 12px;
    margin-top: 8px;
    border-radius: 8px;
    background: rgba(244, 67, 54, 0.15);
    border-left: 4px solid var(--danger);
    color: var(--danger);
    font-weight: 600;
    animation: fadeIn 0.3s ease;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.1);
}

.error-message.show {
    display: flex;
    align-items: center;
}

.error-message i {
    margin-right: 8px;
    font-size: 16px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.server-error {
    background: rgba(244, 67, 54, 0.2);
    border-left: 4px solid #ff5252;
    color: var(--danger);
}

/* Form input error state - Using --danger color */
.form-control.error {
    border-color: var(--danger) !important;
    background-color: rgba(244, 67, 54, 0.05) !important;
    box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2) !important;
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Input focus state with error */
.form-control.error:focus {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3) !important;
}

/* Hover effect for alerts */
.alert:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(244, 67, 54, 0.3);
}

/* Success button styling still uses success color */
.btn-success {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    border: none;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .alert {
        padding: 15px;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .alert-icon {
        margin-bottom: 10px;
        margin-right: 0;
    }
    
    .alert-close {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .alert-content {
        width: 100%;
    }
    
    .error-message {
        font-size: 13px;
        padding: 8px 10px;
    }
}
</style>
{% endblock %}