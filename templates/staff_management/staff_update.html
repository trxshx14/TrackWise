{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
<link rel="stylesheet" href="{% static 'css/staff_management/staff_update.css' %}">
{% endblock %}

{% block title %}Edit {{ staff.user_profile.user.get_full_name }} - TrackWise{% endblock %}

{% block content %}
<div class="auth-body">
    <div class="auth-container staff-update-container">
        <div class="logo-container">
            <div class="logo-text">
                <i class="fas fa-chart-line"></i>
                TrackWise
            </div>
        </div>
        
        <div class="form-section staff-update-section">
            <div class="auth-header">
                <h2>Edit Staff Member</h2>
                <p>Update staff member information</p>
            </div>

            {% comment %} {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %} {% endcomment %}
            
            {% comment %} <div class="staff-image-section">
                <div class="staff-detail-image-placeholder">
                    <i class="fas fa-user fa-4x text-muted"></i>
                    <p>Staff Profile</p>
                </div>
            </div> {% endcomment %}
            
            <form method="post" enctype="multipart/form-data" id="staff-update-form">
                {% csrf_token %}
                
                <h4 style="color: var(--text-white); margin-bottom: 1rem; border-bottom: 2px solid rgba(255, 255, 255, 0.2); padding-bottom: 0.5rem;">Account Information</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="id_first_name">First Name *</label>
                        <input type="text" name="first_name" id="id_first_name" class="form-control" value="{{ staff.user_profile.user.first_name }}" required>
                        <span class="error-message" id="id_first_name_error"></span>
                        {% if profile_form.first_name.errors %}
                            {% for error in profile_form.first_name.errors %}
                                <span class="error-message show" id="server_id_first_name_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="id_last_name">Last Name *</label>
                        <input type="text" name="last_name" id="id_last_name" class="form-control" value="{{ staff.user_profile.user.last_name }}" required>
                        <span class="error-message" id="id_last_name_error"></span>
                        {% if profile_form.last_name.errors %}
                            {% for error in profile_form.last_name.errors %}
                                <span class="error-message show" id="server_id_last_name_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="id_email">Email *</label>
                        <input type="email" name="email" id="id_email" class="form-control" value="{{ staff.user_profile.user.email }}" required>
                        <span class="error-message" id="id_email_error"></span>
                        {% if profile_form.email.errors %}
                            {% for error in profile_form.email.errors %}
                                <span class="error-message show" id="server_id_email_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.employee_id.id_for_label }}">Employee ID *</label>
                        {{ profile_form.employee_id }}
                        <span class="error-message" id="{{ profile_form.employee_id.id_for_label }}_error"></span>
                        {% if profile_form.employee_id.errors %}
                            {% for error in profile_form.employee_id.errors %}
                                <span class="error-message show" id="server_{{ profile_form.employee_id.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <h4 style="color: var(--text-white); margin: 2rem 0 1rem 0; border-bottom: 2px solid rgba(255, 255, 255, 0.2); padding-bottom: 0.5rem;">Employment Information</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.department.id_for_label }}">Department *</label>
                        {{ profile_form.department }}
                        <span class="error-message" id="{{ profile_form.department.id_for_label }}_error"></span>
                        {% if profile_form.department.errors %}
                            {% for error in profile_form.department.errors %}
                                <span class="error-message show" id="server_{{ profile_form.department.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.position.id_for_label }}">Position *</label>
                        {{ profile_form.position }}
                        <span class="error-message" id="{{ profile_form.position.id_for_label }}_error"></span>
                        {% if profile_form.position.errors %}
                            {% for error in profile_form.position.errors %}
                                <span class="error-message show" id="server_{{ profile_form.position.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.hire_date.id_for_label }}">Hire Date *</label>
                        {{ profile_form.hire_date }}
                        <span class="error-message" id="{{ profile_form.hire_date.id_for_label }}_error"></span>
                        {% if profile_form.hire_date.errors %}
                            {% for error in profile_form.hire_date.errors %}
                                <span class="error-message show" id="server_{{ profile_form.hire_date.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.salary.id_for_label }}">Salary</label>
                        {{ profile_form.salary }}
                        <span class="error-message" id="{{ profile_form.salary.id_for_label }}_error"></span>
                        {% if profile_form.salary.errors %}
                            {% for error in profile_form.salary.errors %}
                                <span class="error-message show" id="server_{{ profile_form.salary.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                        <div class="form-text">Optional</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="{{ profile_form.status.id_for_label }}">Status *</label>
                        {{ profile_form.status }}
                        <span class="error-message" id="{{ profile_form.status.id_for_label }}_error"></span>
                        {% if profile_form.status.errors %}
                            {% for error in profile_form.status.errors %}
                                <span class="error-message show" id="server_{{ profile_form.status.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="{{ profile_form.assigned_locations.id_for_label }}">Assigned Locations *</label>
                    {{ profile_form.assigned_locations }}
                    <span class="error-message" id="{{ profile_form.assigned_locations.id_for_label }}_error"></span>
                    {% if profile_form.assigned_locations.errors %}
                        {% for error in profile_form.assigned_locations.errors %}
                            <span class="error-message show" id="server_{{ profile_form.assigned_locations.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                    {% endif %}
                    <div class="form-text">Enter locations separated by commas</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="{{ profile_form.notes.id_for_label }}">Notes</label>
                    {{ profile_form.notes }}
                    <span class="error-message" id="{{ profile_form.notes.id_for_label }}_error"></span>
                    {% if profile_form.notes.errors %}
                        {% for error in profile_form.notes.errors %}
                            <span class="error-message show" id="server_{{ profile_form.notes.id_for_label }}_error">{{ error }}</span>
                            {% endfor %}
                    {% endif %}
                    <div class="form-text">Optional additional information</div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Update Staff
                    </button>
                    <a href="{% url 'staff_management:staff_list' %}" class="btn btn-danger">
                        <i class="fas fa-arrow-left"></i> Back to Staff List
                    </a>
                </div>
            </form>
            
            <div class="auth-footer">
                <p class="footer-content">
                    <a href="{% url 'staff_management:staff_list' %}" class="footer-home-link">
                        <i class="fas fa-arrow-left"></i> Back to Staff List
                    </a>
                    <a>|</a>
                    <span class="footer-spacer"></span>
                    <a href="#" class="footer-support-link">Contact Support</a>
                </p>
            </div>
        </div>

        <div class="particles-section staff-update-particles" id="particles-js"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
    // Particles configuration
    particlesJS('particles-js', {
        particles: {
            number: { value: 60, density: { enable: true, value_area: 600 } },
            color: { value: '#7aa7e0' },
            shape: { type: 'circle' },
            opacity: { value: 0.7, random: true },
            size: { value: 15, random: true },
            line_linked: {
                enable: true,
                distance: 120,
                color: '#7aa7e0',
                opacity: 0.5,
                width: 1.5
            },
            move: {
                enable: true,
                speed: 1.2,
                direction: 'none',
                random: true,
                out_mode: 'out'
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'grab' },
                resize: true
            },
            modes: {
                grab: { distance: 140, line_linked: { opacity: 0.8 } }
            }
        },
        retina_detect: true
    });

    // Form validation
    const form = document.getElementById('staff-update-form');

    // Validation functions
    function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input) {
            input.classList.add('error');
            // Also add to Django's error list if it exists
            const serverError = document.getElementById('server_' + errorId);
            if (serverError) {
                serverError.style.display = 'none';
            }
        }
        if (error) {
            error.textContent = message;
            error.classList.add('show');
        }
    }

    function clearError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input) input.classList.remove('error');
        if (error) error.classList.remove('show');
        
        // Also handle server errors
        const serverError = document.getElementById('server_' + errorId);
        if (serverError) {
            serverError.classList.remove('show');
        }
    }

    function validateForm() {
        let isValid = true;

        // Clear all errors first
        clearError('id_first_name', 'id_first_name_error');
        clearError('id_last_name', 'id_last_name_error');
        clearError('id_email', 'id_email_error');
        clearError('{{ profile_form.employee_id.id_for_label }}', '{{ profile_form.employee_id.id_for_label }}_error');
        clearError('{{ profile_form.department.id_for_label }}', '{{ profile_form.department.id_for_label }}_error');
        clearError('{{ profile_form.position.id_for_label }}', '{{ profile_form.position.id_for_label }}_error');
        clearError('{{ profile_form.hire_date.id_for_label }}', '{{ profile_form.hire_date.id_for_label }}_error');
        clearError('{{ profile_form.status.id_for_label }}', '{{ profile_form.status.id_for_label }}_error');
        clearError('{{ profile_form.assigned_locations.id_for_label }}', '{{ profile_form.assigned_locations.id_for_label }}_error');

        // First name
        const firstName = document.getElementById('id_first_name').value.trim();
        if (!firstName) {
            showError('id_first_name', 'id_first_name_error', 'First name is required');
            isValid = false;
        }

        // Last name
        const lastName = document.getElementById('id_last_name').value.trim();
        if (!lastName) {
            showError('id_last_name', 'id_last_name_error', 'Last name is required');
            isValid = false;
        }

        // Email
        const email = document.getElementById('id_email').value.trim();
        if (!email) {
            showError('id_email', 'id_email_error', 'Email is required');
            isValid = false;
        } else if (!/\S+@\S+\.\S+/.test(email)) {
            showError('id_email', 'id_email_error', 'Please enter a valid email address');
            isValid = false;
        }

        // Employee ID
        const employeeId = document.getElementById('{{ profile_form.employee_id.id_for_label }}').value;
        if (!employeeId) {
            showError('{{ profile_form.employee_id.id_for_label }}', '{{ profile_form.employee_id.id_for_label }}_error', 'Employee ID is required');
            isValid = false;
        }

        // Department
        const department = document.getElementById('{{ profile_form.department.id_for_label }}').value;
        if (!department) {
            showError('{{ profile_form.department.id_for_label }}', '{{ profile_form.department.id_for_label }}_error', 'Department is required');
            isValid = false;
        }

        // Position
        const position = document.getElementById('{{ profile_form.position.id_for_label }}').value;
        if (!position) {
            showError('{{ profile_form.position.id_for_label }}', '{{ profile_form.position.id_for_label }}_error', 'Position is required');
            isValid = false;
        }

        // Hire date
        const hireDate = document.getElementById('{{ profile_form.hire_date.id_for_label }}').value;
        if (!hireDate) {
            showError('{{ profile_form.hire_date.id_for_label }}', '{{ profile_form.hire_date.id_for_label }}_error', 'Hire date is required');
            isValid = false;
        }

        // Status
        const status = document.getElementById('{{ profile_form.status.id_for_label }}').value;
        if (!status) {
            showError('{{ profile_form.status.id_for_label }}', '{{ profile_form.status.id_for_label }}_error', 'Status is required');
            isValid = false;
        }

        // Assigned locations
        const assignedLocations = document.getElementById('{{ profile_form.assigned_locations.id_for_label }}').value;
        if (!assignedLocations) {
            showError('{{ profile_form.assigned_locations.id_for_label }}', '{{ profile_form.assigned_locations.id_for_label }}_error', 'Assigned locations are required');
            isValid = false;
        }

        return isValid;
    }

    // Form submission - validate form
    form.addEventListener('submit', (e) => {
        if (!validateForm()) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.error-message.show');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Clear errors on input
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', () => {
            const errorId = input.id + '_error';
            clearError(input.id, errorId);
        });
    });
</script>
{% endblock %}